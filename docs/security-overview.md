# セキュリティ概要（OnSiteLogistics）

ハンディリーダ（Window D）が扱うデータと運用環境に関するリスク、対策、運用ルールをまとめる。詳細な手順は RUNBOOK および RaspberryPiServer 側文書を参照する。

## 1. 想定するリスク
- **API トークン漏えい**: `/etc/onsitelogistics/config.json` に保存されたトークンが流出すると Pi5 へ不正送信される恐れがある。
- **通信経路の盗聴/改ざん**: Wi-Fi (2.4 GHz) を利用するため、暗号化されていない通信は盗聴・改ざんのリスクがある。
- **端末紛失**: ハンディ端末（Pi Zero 2 W + スキャナ）を紛失した場合、保存済みキューや設定情報が第三者に渡る可能性がある。
- **USB デバイス差し替え**: スキャナを狙った悪意ある USB を接続されると、スクリプトが予期しないデータを処理する恐れがある。
- **ソフトウェア改変**: スクリプトや設定が改変・破壊された場合、Pi5 へ無効なデータが送信される、または送信不能となる。

## 2. 対策方針
- **アクセス制御**: `/etc/onsitelogistics/config.json` は `root:root 640` を維持し、編集は sudo 権限者のみ許可する。API トークンは Pi5 でローテーション可能にする。
- **通信保護**: 現行は HTTP（工場内 LAN）のみ。将来的には Pi5 で HTTPS/TLS を導入し、ハンディ側も `https://` でアクセスする。Wi-Fi の WPA2-PSK を使用し、SSID/パスフレーズは定期更新する。
- **端末管理**: 端末は資産管理台帳へ登録し、稼働状況・バッテリー交換ログを記録する。紛失時は Pi5 側でトークンを失効させ、キュー DB を初期化する。
- **USB デバイス制御**: `setup_serial_env.sh` で VID/PID を固定し、`/dev/minjcode*` 以外はサービス起動前に弾く。予備スキャナ導入時は VID/PID を確認し、ルールを更新する。
- **ソフトウェア保守**: 変更は Git 管理し、リリース前に `git diff` とテストノートで記録する。Pi5 との連携で不整合が生じた場合は速やかにロールバック（旧バージョンへ切替）する。
- **監査ログ**: `handheld_scan_display.py` はローテーションログに送信結果を記録。Pi5 側の `/srv/rpi-server/logs/logistics_audit.log` と突き合わせ、異常送信があれば追跡する。

## 3. 運用ルール
- 設定変更・スクリプト更新は作業前後で `docs/logistics-audit-plan.md` へ記録し、CHANGELOG に反映する。
- API トークン更新時は `install_client_config.sh` で再配置 → `check_connection.sh` で疎通確認 → Pi5 側 `docs/security-overview.md` に記載された手順と整合を取る。
- 端末の持ち出しは最小限とし、使用後は施錠可能な保管庫へ格納。バッテリー交換・故障交換時はシリアル番号を記録する。
- 障害調査時にログを取得する際は機微情報（トークン・個人情報）が含まれていないか確認し、必要に応じてマスキングする。

## 4. 今後の課題
- Pi5 側で TLS 証明書を発行し、ハンディから HTTPS 通信を行う。
- スキャナ固有のシリアル番号を電子ペーパー画面に表示し、交換時に確認できるようにする。
- ハンディ端末のフルディスク暗号化（LUKS）や rootfs 読み取り専用化を検討。
- 監査向けに送信ログを SQLite から Pi5 へ定期送信する仕組みを整備。

この文書は四半期ごと、または大きな構成変更があった際に更新する。
